<?php
// $Id$

function alma_user_theme_registry_alter($theme_registry) {
  $template = 'ding_library_user_personal_info';
  if ($theme_registry[$template]) {
    $modulepath = drupal_get_path('module', 'alma_user');

    // Override template.
    $theme_registry[$template]['template'] = $template;
    // Override path to template.
    $theme_registry[$template]['path'] = $modulepath;
    // Add our path.
    array_unshift($theme_registry[$template]['theme paths'], $modulepath);
  }
}

/**
 * Implementation of hook_ctools_plugin_directory().
 */
function alma_user_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ding_provider') {
    return "plugins/$plugin";
  }
}

/**
 * Implementation of hook_user().
 */
function alma_user_user($op, &$edit, &$account, $category = NULL) {
  if (!$category || $category != 'account') {
    return;
  }
  switch ($op) {
    case 'form':
      $form = array();
      $creds = ding_library_user_get_credentials($account);

      if ($creds != DING_PROVIDER_AUTH_REQUIRED) {
        $info = alma_client_invoke('get_patron_info', $creds['user_id'], $creds['password'], TRUE);

        $form['account']['alma_old_values'] = array(
          '#type' => 'value',
          '#value' => $info,
        );

        $form['account']['alma_user_phone'] = array(
          '#type' => 'textfield',
          '#title' => t('Phone number'),
          '#description' => t('Phone number where the library can contact you. Is not published on the web site.'),
          '#default_value' => $info['phones'][0]['phone'],
          '#element_validate' => array('ding_base_element_validate_phone_number'),
          '#weight' => 1,
        );
      }
      return $form;
      break;
    case 'validate':
      break;
    case 'submit':
      $old_info = $edit['alma_old_values'];
      $creds = ding_library_user_get_credentials($account);

      if ($creds != DING_PROVIDER_AUTH_REQUIRED) {
        if ($edit['mail'] != $account->mail) {
          if (empty($old_info['mails'][0]['id']) && !empty($edit['mail'])) {
            alma_client_invoke('add_email_address', $creds['user_id'], $creds['password'], $edit['mail']);
          }
          elseif (!empty($old_info['mails'][0]['id']) && !empty($edit['mail'])) {
            alma_client_invoke('change_email_address', $creds['user_id'], $creds['password'], $old_info['mails'][0]['id'], $edit['mail']);
          }
        }
        if ($edit['alma_user_phone'] != $old_info['phones'][0]['phone']) {
          if (!empty($edit['alma_user_phone'])) {
            if (empty($old_info['phones'][0]['id'])) {
              alma_client_invoke('add_phone_number', $creds['user_id'], $creds['password'], $edit['alma_user_phone']);
            }
            else {
              alma_client_invoke('change_phone_number', $creds['user_id'], $creds['password'], $old_info['phones'][0]['id'], $edit['alma_user_phone']);
            }
            // If user does not already have a SMS message service then add one
            if (!isset($account->message_services[ALMA_SERVICE_METHOD_SMS][ALMA_SERVICE_TYPE_DUE_DATE_ALERT]) ||
              !$account->message_services[ALMA_SERVICE_METHOD_SMS][ALMA_SERVICE_TYPE_DUE_DATE_ALERT]) {
              // Add a due date alerts as SMS service per default
              alma_client_invoke('add_message_service', $creds['user_id'], $creds['password'], ALMA_SERVICE_METHOD_SMS, ALMA_SERVICE_TYPE_DUE_DATE_ALERT);

              // Update local user settings accordingly
              $account->message_services = array(
                ALMA_SERVICE_METHOD_SMS => array(
                  ALMA_SERVICE_TYPE_DUE_DATE_ALERT => 1
                )
              );
            }
          }
          else {
            if (!empty($old_info['phones'][0]['id'])) {
              alma_client_invoke('remove_phone_number', $creds['user_id'], $creds['password'], $old_info['phones'][0]['id']);
              // Also remove SMS messaging service
              alma_client_invoke('remove_message_service', $creds['user_id'], $creds['password'], ALMA_SERVICE_METHOD_SMS, ALMA_SERVICE_TYPE_DUE_DATE_ALERT);

              // Update local user settings accordingly
              unset($account->message_services[ALMA_SERVICE_METHOD_SMS]);
            }
          }

        }
        unset($edit['alma_old_values'], $edit['alma_user_phone']);
      }
      break;
  }
}

/**
 * Implementation of hook_form_alter().
 *
 * Alter the login form to disable the standard Drupal username/password
 * combination and provide our own fields instead.
 */
function alma_user_form_alter(&$form, $form_state, $form_id) {
  switch ($form_id) {
    case 'user_login':
    case 'user_login_block':
    case 'ding_library_user_authenticate_form':
      // Since the login name can be a user's CPR-number, that too is hidden.
      $form['name']['#type'] = 'password';
    break;
  }
}

/**
 * Validation for settings form.
 */
function ding_library_user_admin_settings_form_validate($form, &$form_state) {
  // Force PIN length to be an integer.
  $form_state['values']['ding_library_user_password_length'] = intval($form_state['values']['ding_library_user_password_length']);

  if ($form_state['values']['ding_library_user_pin_length'] <= 0) {
    form_set_error('ding_library_user_pin_length', t('PIN code length must be a number larger than zero.'));
  }
}

/**
 * Implements hook_ding_library_user_update_info().
 *
 * @param Array $creds
 * @param Array $new_info
 * $new_info = array(
 *   'absent' => array(
 *    'id' => '',
 *    'from_date' => '',
 *    'to_date' => '',
 *  ),
 *  'branch' => '',
 *  'email' => '',
 *  'password' => '',
 *  'phone' => '',
 *  );
 * @param Array $old_info
 * @return void
 *
 * @todo
 *  fold into hook_user()
 */

function alma_user_ding_library_user_update_info($creds, $new_info, $old_info = FALSE) {
  foreach ($new_info as $field_name => $value) {

    if ($old_info && array_key_exists($field_name, $old_info) && $old_info[$field_name] == $value) {
      continue;
    }

    switch ($field_name) {
      case 'absent':
        alma_client_invoke('change_absent_period', $creds['user_id'], $creds['password'], $new_info['absent']['id'], $new_info['absent']['from_date'], $new_info['absent']['to_date']);
      break;
      case 'branch':
        alma_client_invoke('change_patron_preferences', $creds['user_id'], $creds['password'], $value);
      break;
      case 'email':
        if (empty($old_info['mails'][0]['id']) && !empty($value)) {
          alma_client_invoke('add_email_address', $creds['user_id'], $creds['password'], $value);
        }
        elseif (!empty($old_info['mails'][0]['id']) && !empty($value)) {
          alma_client_invoke('change_email_address', $creds['user_id'], $creds['password'], $old_info['mails'][0]['id'], $value);
        }
      break;
      case 'password':
        alma_client_invoke('change_pin', $creds['user_id'], $creds['password'], $value);
      break;
      case 'phones':
        if (!empty($value)) {
          if (empty($old_info['phones'][0]['id'])) {
            alma_client_invoke('add_phone_number', $creds['user_id'], $creds['password'], $value);
          }
          else {
            alma_client_invoke('change_phone_number', $creds['user_id'], $creds['password'], $old_info['phones'][0]['id'], $value);
          }
          // If user does not already have a SMS message service then add one
          if (!isset($account->message_services[ALMA_SERVICE_METHOD_SMS][ALMA_SERVICE_TYPE_DUE_DATE_ALERT]) ||
              !$account->message_services[ALMA_SERVICE_METHOD_SMS][ALMA_SERVICE_TYPE_DUE_DATE_ALERT]) {
            // Add a due date alerts as SMS service per default
            alma_client_invoke('add_message_service', $creds['user_id'], $creds['password'], ALMA_SERVICE_METHOD_SMS, ALMA_SERVICE_TYPE_DUE_DATE_ALERT);

            // Update local user settings accordingly
            $message_services = array(ALMA_SERVICE_METHOD_SMS => array(ALMA_SERVICE_TYPE_DUE_DATE_ALERT => 1));
            $alma_user = array('alma_id' => $account->uid, 'message_services' => serialize($message_services));
            drupal_write_record('alma_user', $alma_user, 'alma_id');
          }
        }
        else {
          if (!empty($old_info['phones'][0]['id'])) {
            alma_client_invoke('remove_phone_number', $creds['user_id'], $creds['password'], $old_info['phones'][0]['id']);
            // Also remove SMS messaging service
            alma_client_invoke('remove_message_service', $creds['user_id'], $creds['password'], ALMA_SERVICE_METHOD_SMS, ALMA_SERVICE_TYPE_DUE_DATE_ALERT);

            // Update local user settings accordingly
            unset($account->message_services[ALMA_SERVICE_METHOD_SMS]);
            $alma_user = array('alma_id' => $account->uid, 'message_services' => serialize($account->message_services));
            drupal_write_record('alma_user', $alma_user, 'alma_id');

          }
        }
      break;
    }
  }
}

/**
 * Get list of Alma block codes with their descriptions.
 */
function alma_user_block_codes() {
  return array(
    'a' => 'Forkert adresse',
    'c' => 'CPR-nr. fejl jf. folkeregister',
    'd' => 'Låneren død jf. folkeregister',
    'f' => 'Forældre-forbud',
    'g' => 'Låneforbud',
    'o' => 'Oprettet under nødudlån - låner skal i',
    's' => 'Blokeret af selvbetjeningsterminal',
    'u' => 'ukendt adresse i folkeregister',
    'v' => 'Lånerkort/sygesik. væk',
    'x' => 'Forsvundet jf. folkeregistret',
  );
}

// Reservation related functions.

/**
 * Element validator.
 */
function alma_user_element_validate_reservation_options(&$element, &$form_state, $complete_form) {
  if (form_get_errors() || $form_state['clicked_button']['#op'] != 'reserve') {
    return;
  }
  $reservations = $form_state['values']['reservations'];

  foreach (array_filter($form_state['values']['selected']) as $id) {
    // Detect fetchable reservations...
    if (($reservations[$id]['status'] == 'fetchable')) {
      if (!empty($form_state['values']['expiry'])) {
        form_error($complete_form['selected'][$id], t('You can not change expiry on reservations which are ready for pick up'));
      }
      if ($form_state['values']['pickup_branch'] != $reservations[$id]['pickup_branch']) {
        form_error($complete_form['selected'][$id], t('You can not change pickup branch on reservations which are ready for pick up'));
      }
    }
  }

  if (!empty($form_state['values']['expiry'])) {
    list($year, $month, $day) = explode('-', trim($form_state['values']['expiry']));
    if (!checkdate($month, $day, $year)) {
      form_error($element['expiry'], t('Invalid date'));
    }

    $timestamp = strtotime($form_state['values']['expiry']);

    if ($timestamp <= $_SERVER['REQUEST_TIME']) {
      form_error($element['expiry'], t('Date must be later than today.'));
    }
    else {
      form_set_value($element['expiry'], format_date($timestamp, 'custom', 'Y-m-d'), $form_state);
    }
  }
}

/**
 *
 */
function alma_user_preprocess_ding_library_user_personal_info(&$vars) {
  // Using a cache, as panels causes this to be called twice.
  static $info_cache;
  $creds = ding_library_user_get_credentials($vars['account']);

  if ($creds != DING_PROVIDER_AUTH_REQUIRED) {
    if (!isset($info_cache[$vars['account']->uid])) {
      $info_cache[$vars['account']->uid] = alma_client_invoke('get_patron_info', $creds['user_id'], $creds['password'], TRUE);
    }
    $info = $info_cache[$vars['account']->uid];
    $fields = array('street', 'postal_code', 'city');
    foreach ($fields as $field) {
      $vars[$field] = $info['addresses'][0][$field] ? check_plain($info['addresses'][0][$field]) : '';
    }

    $vars['phone'] = $info['phones'][0]['phone'] ? check_plain($info['phones'][0]['phone']) : '';
  }
}

// Debt related functions

/**
 *
 */
function alma_user_form_ding_debt_list_form_alter(&$form, $form_state) {
  if (function_exists('ding_dibs_payment_prepare')) {
    $form['buttons']['pay'] = array(
      '#type' => 'submit',
      '#value' => t('Pay selected'),
      '#attributes' => array('class' => 'update-button'),
      '#submit' => array('alma_user_ding_debt_list_form_pay'),
    );
  }
}

/**
 *
 */
function alma_user_ding_debt_list_form_pay($form, &$form_state) {
  $creds = ding_library_user_get_credentials($form_state['values']['account']);
  if ($creds == DING_PROVIDER_AUTH_REQUIRED) {
    drupal_set_message(t('You must be logged in to pay fines.'), 'error');
    return;
  }

  $patron = alma_client_invoke('get_patron_info', $creds['borr_card'], $creds['pin_code']);

  $params = array(
    'customer_name' => $patron['patron_name'],
    'customer_address' => $patron['addresses'][0]['street'],
    'customer_address_2' => $patron['addresses'][0]['care_of'],
    'customer_city' => $patron['addresses'][0]['city'],
    'customer_zipcode' => $patron['addresses'][0]['postal_code'],
    'customer_email' => $patron['mails'][0]['mail'],
    'customer_phone' => $patron['phones'][0]['phone'],
    // Send the selected parameters along so we can use them to settle
    // the debts in Alma.
    'params' => array('selected_debts' => $form_state['values']['selected']),
  );
  ding_dibs_payment_prepare($form_state['values']['total'], $params, 'alma_user_debt_dibs_add_payment');
}

/**
 *
 */
function alma_user_debt_dibs_add_payment($transaction) {
  global $user;
  $creds = ding_library_user_get_credentials($user);

  alma_client_invoke('add_payment', implode(',', $transaction['params']['selected_debts']), $transaction['payment_order_id']);
}
